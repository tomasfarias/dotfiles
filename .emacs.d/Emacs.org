# -*- mode: org; coding: utf-8; -*-
#+ TITLE: My EMACS configuration
#+ AUTHOR: Tomás Farías Santana

* General settings

Enable syntax-highlighting for all buffers:
#+BEGIN_SRC emacs-lisp
  (global-font-lock-mode t)
#+END_SRC

Ensure environment variables (like PATH) are loaded from SHELL:
#+BEGIN_SRC emacs-lisp
  (use-package exec-path-from-shell)
  (when (memq window-system '(mac ns x))
    (exec-path-from-shell-initialize))
  (when (daemonp)
    (exec-path-from-shell-initialize))
#+END_SRC

Disable many things:
#+BEGIN_SRC emacs-lisp
  (when (functionp 'menu-bar-mode)
    (menu-bar-mode -1))
  (when (functionp 'set-scroll-bar-mode)
    (set-scroll-bar-mode 'nil))
  (when (functionp 'mouse-wheel-mode)
    (mouse-wheel-mode -1))
  (when (functionp 'tooltip-mode)
    (tooltip-mode -1))
  (when (functionp 'tool-bar-mode)
    (tool-bar-mode -1))
  (when (functionp 'blink-cursor-mode)
    (blink-cursor-mode -1))

  (setq inhibit-startup-message t
        initial-major-mode 'fundamental-mode)
#+END_SRC

Backup files in system's temp directory:
#+BEGIN_SRC emacs-lisp
  (setq backup-directory-alist
        `((".*" . ,temporary-file-directory)))
  (setq auto-save-file-name-transforms
        `((".*" ,temporary-file-directory t)))
#+END_SRC

Shorter yes/no:
#+BEGIN_SRC emacs-lisp
  (defalias 'yes-or-no-p 'y-or-n-p)
#+END_SRC

Ensure UTF-8 everywhere:
#+BEGIN_SRC emacs-lisp
  (prefer-coding-system 'utf-8)
  (set-default-coding-systems 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
  (setq default-buffer-file-coding-system 'utf-8)
#+END_SRC

* Aesthetics

Set up gruvbox theme:
#+BEGIN_SRC emacs-lisp
  (use-package gruvbox-theme
    :config (load-theme 'gruvbox-dark-hard t))
#+END_SRC

Doom-modeline:
#+BEGIN_SRC emacs-lisp
  (use-package all-the-icons)
  (use-package doom-modeline
    :init (doom-modeline-mode 1))
#+END_SRC

Ensure line and column numbers:
#+BEGIN_SRC emacs-lisp
  (line-number-mode 1)
  (column-number-mode 1)
#+END_SRC

Hide the mouse while typing:
#+BEGIN_SRC emacs-lisp
  (setq make-pointer-invisible t)
#+END_SRC

By default, do not indent with tabs:
#+BEGIN_SRC emacs-lisp
  (setq-default indent-tabs-mode nil)
#+END_SRC

Attempt to set default font:
#+BEGIN_SRC emacs-lisp
  (when (member "Hack-Regular" (font-family-list))
    (set-frame-font "Hack-Regular-13:Regular" t t))
#+END_SRC

Display line numbers everywhere:
#+BEGIN_SRC emacs-lisp
  (global-display-line-numbers-mode)
#+END_SRC

Customize my EMACS Dashboard:
#+BEGIN_SRC emacs-lisp
  (use-package page-break-lines)

  (use-package dashboard
    :config (dashboard-setup-startup-hook)
    (setq dashboard-startup-banner 'logo)
    (setq dashboard-banner-logo-title "Get to work!")
    (setq dashboard-set-heading-icons t)
    (setq dashboard-set-file-icons t)
    (setq dashboard-set-init-info t)
    (setq dashboard-projects-backend 'projectile)
    (setq dashboard-items '((recents  . 5)
                            (bookmarks . 5)
                            (projects . 5)
                            (agenda . 5)
                            (registers . 5))))
#+END_SRC

* Productivity modes

Magit:
#+BEGIN_SRC emacs-lisp
  (use-package magit
    :config (global-set-key (kbd "C-c g") 'magit-file-dispatch))

  (use-package pinentry
    :config
    (setf epg-pinentry-mode 'loopback)
    (pinentry-start))
#+END_SRC

Projectile:
#+BEGIN_SRC emacs-lisp
   (use-package projectile
    :diminish projectile-mode
    :init
    (setq projectile-keymap-prefix (kbd "C-c p"))
    :config
    (projectile-global-mode))
#+END_SRC

Treemacs mode for file and project exploring:
#+BEGIN_SRC emacs-lisp
  (use-package treemacs
    :config
    (progn
      (treemacs-follow-mode t)
      (treemacs-filewatch-mode t)
      (treemacs-fringe-indicator-mode 'always)
      (pcase (cons (not (null (executable-find "git")))
                   (not (null treemacs-python-executable)))
        (`(t . t)
         (treemacs-git-mode 'deferred))
        (`(t . _)
         (treemacs-git-mode 'simple))))
    :bind (:map global-map
                ("<f8>" . treemacs)))

  (use-package treemacs-magit
    :after (treemacs magit))

  (use-package treemacs-projectile
    :after (treemacs projectile))
#+END_SRC

Undo-tree with undo and redo bindings:
#+BEGIN_SRC emacs-lisp
  (use-package undo-tree
    :config (global-undo-tree-mode 1)
    (global-set-key (kbd "C-z") 'undo)
    (defalias 'redo 'undo-tree-redo)
    (global-set-key (kbd "C-S-z") 'redo))
#+END_SRC

Ivy includes swiper, counsel, and ivy itself. These replace some standard commands as global bindings are set:
#+BEGIN_SRC emacs-lisp
  (use-package ivy
    :config
    (global-set-key (kbd "C-x b") 'ivy-switch-buffer)
    (global-set-key (kbd "C-c v") 'ivy-push-view)
    (global-set-key (kbd "C-c V") 'ivy-pop-view))

  (use-package counsel
    :after ivy
    :config
    (counsel-mode)
    (global-set-key (kbd "M-x") 'counsel-M-x)
    (global-set-key (kbd "C-x C-f") 'counsel-find-file)
    (global-set-key (kbd "<f1> f") 'counsel-describe-function)
    (global-set-key (kbd "<f1> v") 'counsel-describe-variable)
    (global-set-key (kbd "<f1> o") 'counsel-describe-symbol)
    (global-set-key (kbd "<f1> l") 'counsel-find-library)
    (global-set-key (kbd "<f2> i") 'counsel-info-lookup-symbol)
    (global-set-key (kbd "<f2> u") 'counsel-unicode-char)
    (global-set-key (kbd "<f2> j") 'counsel-set-variable)
    )

  (use-package swiper
    :after ivy
    :config (global-set-key (kbd "C-s") 'swiper-isearch))
#+END_SRC

Whitespace mode:

#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "C-c t") 'whitespace-mode)
#+END_SRC

Rainbows:
#+BEGIN_SRC emacs-lisp
  (use-package rainbow-delimiters)
#+END_SRC

Multiple cursors:

#+BEGIN_SRC emacs-lisp
  (use-package multiple-cursors
    :config (global-set-key (kbd "C-S-c C-S-c") 'mc/edit-lines)
    (global-set-key (kbd "C->") 'mc/mark-next-like-this)
    (global-set-key (kbd "C-<") 'mc/mark-previous-like-this)
    (global-set-key (kbd "C-c C-<") 'mc/mark-all-like-this)
    )
#+END_SRC

* Everything org

Set base org directory and default notes file:

#+BEGIN_SRC emacs-lisp
  (defconst org-directory "~/src/github.com/tomasfarias/org/"
    "org-mode directory and repo, where most of the org-mode file lives")
  (defconst org-projects-dir (expand-file-name "projects" org-directory)
    "Primary tasks directory.")
  (defconst org-notes-dir (expand-file-name "notes" org-directory)
    "Directory of shareable, technical notes.")
  (defconst org-journal-dir (expand-file-name "journal" org-directory)
    "Directory of journal notes.")
  (defconst org-inbox-file (expand-file-name "Inbox.org" org-directory)
    "New stuff collected in this file.")
  (defconst org-work-inbox-file (expand-file-name "WorkInbox.org" org-directory)
    "New work-related stuff collected in this file.")
  (defconst org-babel-library-file (expand-file-name "org_library_of_babel.org" org-notes-dir)
    "Org babel library.")
#+END_SRC

The org itself:

#+BEGIN_SRC emacs-lisp
    (use-package org
      :init
      (setq org-use-speed-commands t
            org-return-follows-link t
            org-hide-emphasis-markers t
            org-completion-use-ido t
            org-outline-path-complete-in-steps nil
            org-src-fontify-natively t
            org-startup-indented t
            org-src-tabs-acts-natively t
            org-log-done 'time
            org-log-into-drawer t
            org-agenda-files (quote ("~/src/github.com/tomasfarias/org"
                                     "~/src/github.com/tomasfarias/org/projects"))
            org-agenda-span 10
            org-agenda-start-on-weekday 1
            org-agenda-include-diary nil
            org-agenda-window-setup 'current-window
            org-agenda-skip-scheduled-if-done nil
            org-agenda-compact-blocks t
            org-agenda-sticky t
            org-super-agenda-header-separator ""
            org-todo-keywords
            (quote ((sequence "TODO(t)" "PROG(p)" "|" "DONE(d)")
                    (sequence "WAITING(w@/!)" "|" "CANCELLED(c@/!)"))))

      (add-to-list 'auto-mode-alist '("\\.txt\\'" . org-mode))
      (add-to-list 'auto-mode-alist '("\\.org\\'" . org-mode))

      :bind (("C-c o l" . org-store-link)
             ("C-c o r r" . org-refile)
             ("C-c o a a" . org-agenda)
             ("<f9>" . org-agenda)
             ("C-c o s" . org-sort)
             ("C-c o c" . org-capture)
             ("C-M-|" . indent-rigidly))
      :config
      (add-hook 'org-mode-hook 'visual-line-mode)
      (add-hook 'org-mode-hook 'flyspell-mode))

    (use-package slime
      :config (setq inferior-lisp-program "sbcl"))

    (org-babel-do-load-languages
     'org-babel-load-languages
     '((lisp . t)
       (emacs-lisp . t)
       (python . t)))

    (use-package org-super-agenda
      :config (org-super-agenda-mode))

    (use-package org-journal
      :commands (org-journal-new-entry org-capture)
      :after (org-capture)
      :bind
      (("C-c n j" . org-journal-new-entry)
       ("C-c o j" . org-journal-new-entry))
      :custom
      (org-journal-dir org-journal-dir)
      (org-journal-date-format "%A, %d %B %Y")
      (org-journal-enable-agenda-integration t))

#+END_SRC

Set-up org-capture templates:

#+BEGIN_SRC emacs-lisp
  (defun org-journal-find-location ()
    ;; Open today's journal, but specify a non-nil prefix argument in order to
    ;; inhibit inserting the heading; org-capture will insert the heading.
    (org-journal-new-entry t)
    (unless (eq org-journal-file-type 'daily)
      (org-narrow-to-subtree))
    (goto-char (point-max)))

  (setq org-capture-templates
        '(("t" "Inbox" entry (file org-inbox-file)
           "* TODO %?
                  SCHEDULED: %t")
          ("w" "Work inbox" entry (file org-work-inbox-file)
           "* TODO %?
                  SCHEDULED: %t
                  DEADLINE: %t")
          ("n" "Notes" entry (file org-notes-file)
           "* %T\n%i%?")
          ("j" "Journal" plain (function org-journal-find-location)
           "** %(format-time-string org-journal-time-format)%^{Title}\n%i%?"
           :jump-to-captured t
           :immediate-finish t)))
#+END_SRC

Install org-roam, bibliography management dependencies, and set-up keyboard shortcuts:

#+BEGIN_SRC emacs-lisp
  (use-package org-roam
    :init (setq org-roam-v2-ack t)
    :bind (("C-c n l" . org-roam-buffer-toggle)
           ("C-c n f" . org-roam-node-find)
           ("C-c n g" . org-roam-graph)
           ("C-c n i" . org-roam-node-insert)
           ("C-c n c" . org-roam-capture)
           ("C-c n j" . org-roam-dailies-capture-today)
           ("C-c n C-t" . org-roam-tag-add)
           ("C-c n C-S-t" . org-roam-tag-remove))
    :config (setq org-roam-directory org-directory)
    (setq org-roam-db-location (concat org-roam-directory "org-roam.db")
          org-roam-capture-templates '(("n" "Note" plain "%?"
                                        :if-new (file+head "${slug}.org"
                                                           "#+TITLE: ${title}\n#+DATE: %U\n\n")
                                        :unnarrowed t
                                        :immediate-finish t)
                                       ("r" "Bibliography reference" plain "%?"
                                        :if-new (file+head "${citekey}.org"
                                                           "#+TITLE: ${title}\n#+DATE: %U\n#+LASTMOD: \n#+STARTUP: inlineimages latexpreview\n*topics*: \n\n${fullcite}")
                                        :unnarrowed t
                                        :immediate-finish t)

                                       ("s" "Study notes" plain "%?"
                                        :if-new (file+head "${slug}.org"
                                                           "#+TITLE: ${title}\n#+AUTHOR:\n#+ROAM_KEY: \n#+STARTUP: inlineimages latexpreview\n\n")
                                        :unnarrowed t
                                        :immediate-finish t))))

  (setq bibtex-completion-bibliography (concat org-directory "/bibliography/references.bib")
        bibtex-completion-library-path (concat org-directory "/bibliography/pdfs")
        bibtex-completion-notes-path (concat org-directory "/bibliography/notes"))
  (setq bibtex-completion-pdf-open-function 'org-open-file)
  (use-package helm-bibtex
    :after helm)

  (setq reftex-default-bibliography (concat org-directory "/bibliography/references.bib"))
  (setq org-ref-bibliography-notes (concat org-directory "/bibliography/notes.org")
        org-ref-default-bibliography (concat org-directory "/bibliography/references.bib")
        org-ref-pdf-directory (concat org-directory "/bibliography/pdfs/"))

  (use-package org-ref
    :after org-roam)

  (use-package org-roam-bibtex
    :straight t
    :after org-roam
    :hook (org-roam-mode . org-roam-bibtex-mode)
    :config (require 'org-ref)
    (setq org-roam-bibtex-preformat-keywords
          '("title" "url" "author-or-editor" "keywords" "date")))
#+END_SRC

* IRC with ERC

Set nickname, real-name, and define a function to connect to [[irc.libera.chat]].

#+BEGIN_SRC emacs-lisp
  (setq
   erc-nick "tomasfarias"
   erc-user-full-name "Tomás Farías")

  (defun erc-libera-start ()
    (lambda ()
      (interactive)
      (erc :server "irc.libera.chat"
           :port   "6667")))
#+END_SRC

* Language modes

Python language mode settings:
#+BEGIN_SRC emacs-lisp
  (use-package pyvenv
    :ensure t
    :init
    (setenv "WORKON_HOME" "~/.pyenv/versions")
    (pyvenv-tracking-mode 1))

  (use-package py-isort
    :config (add-hook 'before-save-hook 'py-isort-before-save))

  (use-package blacken
    :hook (python-mode . blacken-mode)
    :config
    (setq blacken-only-if-project-is-blackened t))

  (add-hook 'python-mode-hook
            (lambda ()
              (setq-default tab-width 4)
              (add-to-list 'write-file-functions 'delete-trailing-whitespace)
              (setq whitespace-style '(face empty trailing indentation::space))
              (add-to-list 'company-backends 'company-jedi)))

  (add-hook 'python-mode-hook #'rainbow-delimiters-mode)
#+END_SRC

Arduino mode:
#+BEGIN_SRC emacs-lisp
  (use-package arduino-mode
    :after flycheck)
#+END_SRC

Terraform language mode:
#+BEGIN_SRC emacs-lisp
  (use-package terraform-mode)
#+END_SRC

Dockerfile mode:
#+BEGIN_SRC emacs-lisp
  (use-package dockerfile-mode
    :config (add-to-list 'auto-mode-alist '("Dockerfile\\'" . dockerfile-mode)))
#+END_SRC

Groovy language mode:
#+BEGIN_SRC emacs-lisp
  (use-package groovy-mode
    :config (setq groovy-indent-offset 2))
#+END_SRC

Markdown mode:
#+BEGIN_SRC emacs-lisp
  (use-package markdown-mode
    :mode ("README\\.md\\'" . gfm-mode)
    :init (setq markdown-command "multimarkdown"))
#+END_SRC

YAML mode:
#+BEGIN_SRC emacs-lisp
  (use-package yaml-mode
    :mode ("\\.yml\\'" . yaml-mode)
    ("\\.yaml\\'" . yaml-mode))
#+END_SRC

Language server protocol for auto-completion with company-mode:
#+BEGIN_SRC emacs-lisp
  (use-package company
    :config (add-hook 'after-init-hook 'global-company-mode)
    (setq company-idle-delay 1)
    (setq company-minimum-prefix-length 3)
    (setq company-selection-wrap-around t)
    (setq company-show-numbers 1)
    (define-key company-active-map (kbd "C-n") 'company-select-next)
    (define-key company-active-map (kbd "C-p") 'company-select-previous)
    (define-key company-active-map (kbd "M-<") 'company-select-first)
    (define-key company-active-map (kbd "M->") 'company-select-last))

  (use-package which-key
    :config
    (which-key-mode))

  (use-package lsp-mode
    :init
    :custom
    ;; what to use when checking on-save. "check" is default, I prefer clippy
    (lsp-rust-analyzer-cargo-watch-command "clippy")
    (lsp-eldoc-render-all nil)
    (lsp-idle-delay 0.5)
    :hook
    (python-mode . lsp)
    (rustic-mode . lsp)
    (groovy-mode . lsp)
    (terraform-mode . lsp)
    (lsp-mode . lsp-enable-which-key-integration)
    :commands
    (lsp lsp-deferred)
    :config
    (setq lsp-keymap-prefix "C-c s")
    (setq rustic-lsp-server 'rust-analyzer)
    (setq rustic-analyzer-command '("rust-analyzer"))
    (add-hook 'lsp-mode-hook 'lsp-ui-mode)
    (add-to-list 'lsp-enabled-clients 'rust-analyzer)
    (add-hook 'lsp-after-open-hook 'lsp-enable-imenu)
    (setq lsp-enable-symbol-highlighting t
          lsp-modeline-diagnostics-enable t
          lsp-modeline-code-actions-enable t
          lsp-lens-enable nil
          lsp-eldoc-enable-hover nil
          lsp-signature-auto-activate nil
          lsp-completion-enable t
          lsp-completion-show-detail t
          lsp-completion-show-kind t))

  (use-package lsp-ui
    :commands lsp-ui-mode
    :config (setq lsp-ui-doc-enable nil
                  lsp-ui-doc-use-childframe t
                  lsp-ui-doc-position 'top
                  lsp-ui-doc-include-signature t
                  lsp-ui-sideline-enable nil
                  lsp-ui-flycheck-enable t
                  lsp-ui-flycheck-list-position 'right
                  lsp-ui-flycheck-live-reporting nil
                  lsp-ui-peek-enable nil
                  lsp-ui-peek-list-width 60
                  lsp-ui-peek-peek-height 25
                  ))

  (use-package lsp-treemacs
    :commands lsp-treemacs-errors-list)

  (use-package lsp-jedi
    :ensure t
    :config
    (with-eval-after-load "lsp-mode"
      (add-to-list 'lsp-disabled-clients 'pyls)
      (add-to-list 'lsp-enabled-clients 'jedi)))
#+END_SRC

#+RESULTS:
: t

Solidity language mode:
#+BEGIN_SRC emacs-lisp
  (use-package solidity-mode
    :config (setq solidity-comment-style 'slash))
#+END_SRC

Rust language mode:
#+BEGIN_SRC emacs-lisp
  (use-package rust-mode
    :config
    (add-hook 'racer-mode-hook #'eldoc-mode)
    (add-hook 'racer-mode-hook #'company-mode)
    (define-key rust-mode-map (kbd "TAB") #'company-indent-or-complete-common)
    (setq rust-format-on-save t)
    (setq rust-indent-offset 4))

  (use-package cargo-mode
    :config
    (add-hook 'rust-mode-hook 'cargo-minor-mode))

  (provide 'init-rust-mode)
#+END_SRC

Syntax checking with flycheck:
#+BEGIN_SRC emacs-lisp
  (use-package flycheck
    :init (global-flycheck-mode))

  (use-package flycheck-rust)
  (push 'rustic-clippy flycheck-checkers)
  (setq rustic-flycheck-clippy-params "--message-format=json")
  (with-eval-after-load 'rustic-mode
    (add-hook 'flycheck-mode-hook #'flycheck-rust-setup))

  (use-package solidity-flycheck)
#+END_SRC
